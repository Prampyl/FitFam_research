{"cells":[{"cell_type":"code","source":["import pandas as pd\n","\n","# Load relevant files\n","events = pd.read_json('events.json')\n","event_user = pd.read_json('event_user.json')\n","cancellation_reasons = pd.read_json('cancellation_reasons.json')\n","cancellation_reason_event = pd.read_json('cancellation_reason_event.json')\n","\n","# Display head and info to understand structure\n","print(\"Events:\")\n","print(events.info())\n","print(events.head())\n","\n","print(\"\\nEvent User:\")\n","print(event_user.info())\n","print(event_user.head())\n","\n","print(\"\\nCancellation Reasons:\")\n","print(cancellation_reasons.head())\n","\n","print(\"\\nCancellation Reason Event:\")\n","print(cancellation_reason_event.head())"],"outputs":[],"execution_count":null,"metadata":{"id":"1n92TpzcPIwx"}},{"cell_type":"markdown","source":["```text?code_stdout&code_event_index=2\n","Events:\n","<class 'pandas.core.frame.DataFrame'>\n","RangeIndex: 37630 entries, 0 to 37629\n","Data columns (total 21 columns):\n"," #   Column              Non-Null Count  Dtype         \n","---  ------              --------------  -----         \n"," 0   id                  37630 non-null  int64         \n"," 1   user_id             0 non-null      float64       \n"," 2   recurring_group_id  37630 non-null  int64         \n"," 3   location_id         37630 non-null  int64         \n"," 4   name                37630 non-null  object        \n"," 5   description         37630 non-null  object        \n"," 6   to_bring            37630 non-null  object        \n"," 7   start_time          37630 non-null  datetime64[ns]\n"," 8   end_time            37630 non-null  datetime64[ns]\n"," 9   registration_start  37630 non-null  object        \n"," 10  registration_end    37630 non-null  object        \n"," 11  max_attendees       24510 non-null  float64       \n"," 12  frequency_details   37615 non-null  object        \n"," 13  contact_name        37630 non-null  object        \n"," 14  contact_wechat      37630 non-null  object        \n"," 15  is_aqi_dependent    27046 non-null  float64       \n"," 16  is_featured         37630 non-null  int64         \n"," 17  members_only        37630 non-null  int64         \n"," 18  status              37630 non-null  object        \n"," 19  created_at          37630 non-null  datetime64[ns]\n"," 20  updated_at          37630 non-null  datetime64[ns]\n","dtypes: datetime64[ns](4), float64(3), int64(5), object(9)\n","memory usage: 6.0+ MB\n","None\n","   id  user_id  recurring_group_id  location_id                                                      name                                                                                                         description                                                                to_bring          start_time            end_time   registration_start     registration_end  max_attendees                                                                     frequency_details               contact_name                 contact_wechat  is_aqi_dependent  is_featured  members_only     status          created_at          updated_at\n","0   1      NaN                   1            1  {\"en\": \"{{ Workout/Name }}\", \"zh\": \"{{ Workout/Name }}\"}                                              {\"en\": \"{{ Workout/Description }}\", \"zh\": \"{{ Workout/Description }}\"}  {\"en\": \"{{ Workout/WhatToBring }}\", \"zh\": \"{{ Workout/WhatToBring }}\"} 2018-08-07 10:00:00 2018-08-07 11:00:00  2018-08-06 09:00:00  2018-08-07 10:00:00            5.0  {\"en\": \"{{ Workout/RecurringFrequency }}\", \"zh\": \"{{ Workout/RecurringFrequency }}\"}  {{ Workout/ContactName }}  {{ Workout/ContactWeChatID }}               1.0            0             0    deleted 2018-08-06 08:58:30 2018-08-06 21:18:51\n","1   2      NaN                   2            2                {\"en\": \"naked Hub Taixing \", \"zh\": \"dasf\"}                           {\"en\": \"We take a lucky group of 25x FitFam through some HIIT on your Thursday morning.\"}      {\"en\": \"Water & gloves, yoga mat optional\", \"zh\": \"askdjflaskjdf\"} 2018-08-08 06:00:00 2018-08-08 07:00:00  2018-08-07 14:00:00  2018-08-08 06:00:00           15.0                                           {\"en\": \"Every Wednesday 6AM\", \"zh\": \"sdfa\"}            Olivia Plotnick                 oliviaplotnick               1.0            0             0    deleted 2018-08-06 21:03:38 2018-08-06 21:18:57\n","2   3      NaN                   2            2                {\"en\": \"naked Hub Taixing \", \"zh\": \"dasf\"}                           {\"en\": \"We take a lucky group of 25x FitFam through some HIIT on your Thursday morning.\"}      {\"en\": \"Water & gloves, yoga mat optional\", \"zh\": \"askdjflaskjdf\"} 2018-08-12 15:00:00 2018-08-12 15:00:00  2018-08-07 14:00:00  2018-08-12 15:00:00           25.0                                           {\"en\": \"Every Wednesday 6AM\", \"zh\": \"sdfa\"}            Olivia Plotnick                 oliviaplotnick               1.0            0             0    deleted 2018-08-06 21:06:38 2018-08-12 16:10:22\n","3   4      NaN                   3            3                      {\"en\": \"Fuxing Park\", \"zh\": \"sfasd\"}  {\"en\": \"As always, another HIIT/ Bodyweight workout including warmup and stretches in a full hour.\", \"zh\": \"dfas\"}                                  {\"en\": \"Water & gloves\", \"zh\": \"asdf\"} 2018-08-07 06:00:00 2018-08-07 07:00:00  2018-08-06 14:00:00  2018-08-07 06:00:00            NaN                                         {\"en\": \"Every Monday - Friday\", \"zh\": \"asdf\"}            Olivia Plotnick                 oliviaplotnick               1.0            0             0  published 2018-08-06 21:14:35 2018-08-06 21:14:35\n","4   5      NaN                   3            3                      {\"en\": \"Fuxing Park\", \"zh\": \"sfasd\"}  {\"en\": \"As always, another HIIT/ Bodyweight workout including warmup and stretches in a full hour.\", \"zh\": \"dfas\"}                                  {\"en\": \"Water & gloves\", \"zh\": \"asdf\"} 2018-08-08 06:00:00 2018-08-08 07:00:00  2018-08-07 14:00:00  2018-08-08 06:00:00            NaN                                         {\"en\": \"Every Monday - Friday\", \"zh\": \"asdf\"}            Olivia Plotnick                 oliviaplotnick               1.0            0             0  cancelled 2018-08-06 21:14:35 2018-08-07 15:25:42\n","\n","Event User:\n","<class 'pandas.core.frame.DataFrame'>\n","RangeIndex: 405861 entries, 0 to 405860\n","Data columns (total 6 columns):\n"," #   Column      Non-Null Count   Dtype         \n","---  ------      --------------   -----         \n"," 0   event_id    405861 non-null  int64         \n"," 1   user_id     405861 non-null  int64         \n"," 2   checked_in  394779 non-null  float64       \n"," 3   is_leader   405861 non-null  int64         \n"," 4   created_at  405861 non-null  datetime64[ns]\n"," 5   updated_at  405861 non-null  datetime64[ns]\n","dtypes: datetime64[ns](2), float64(1), int64(3)\n","memory usage: 18.6 MB\n","None\n","   event_id  user_id  checked_in  is_leader          created_at          updated_at\n","0         1        1         NaN          0 2018-08-06 11:10:14 2018-08-06 11:10:14\n","1         1        3         NaN          0 2018-08-06 21:42:05 2018-08-06 21:42:05\n","2         3        1         1.0          0 2018-08-12 12:12:50 2018-08-12 12:12:50\n","3         3        3         0.0          0 2018-08-07 14:39:25 2018-08-07 14:39:25\n","4         3        4         1.0          0 2018-08-07 14:39:54 2018-08-07 14:39:54\n","\n","Cancellation Reasons:\n","   id                                                name     slug created_at updated_at\n","0   1  {\"en\": \"AQI higher than 150\", \"zh\": \"空气质量指数超过150\"}      aqi        NaT        NaT\n","1   2             {\"en\": \"Adverse weather\", \"zh\": \"不良天气\"}  weather        NaT        NaT\n","2   3                         {\"en\": \"Other\", \"zh\": \"其他\"}    other        NaT        NaT\n","\n","Cancellation Reason Event:\n","   cancellation_reason_id  event_id  user_id          created_at          updated_at\n","0                       1         5        2 2018-08-07 15:25:42 2018-08-07 15:25:42\n","1                       1        13        1 2018-08-07 16:52:54 2018-08-07 16:52:54\n","2                       1       107        2 2018-09-09 07:20:49 2018-09-09 07:20:49\n","3                       1       311      903 2018-10-10 05:22:59 2018-10-10 05:22:59\n","4                       1       315      450 2018-10-10 05:23:02 2018-10-10 05:23:02\n","\n","```"],"metadata":{"id":"3nZoMtbYPIw1"}},{"cell_type":"code","source":["import pandas as pd\n","import numpy as np\n","\n","# Merge events and event_user\n","# Filter for checked_in = 1\n","attended = event_user[event_user['checked_in'] == 1].copy()\n","df = attended.merge(events[['id', 'start_time']], left_on='event_id', right_on='id', how='left')\n","\n","# Drop missing start_times if any\n","df = df.dropna(subset=['start_time'])\n","\n","# Extract month\n","df['month'] = df['start_time'].dt.month\n","df['year'] = df['start_time'].dt.year\n","\n","# Define Extreme Months: Jan(1), Feb(2), Jul(7), Aug(8), Dec(12)\n","extreme_months = [1, 2, 7, 8, 12]\n","df['is_extreme'] = df['month'].isin(extreme_months).astype(int)\n","\n","# --- Analysis 1: Retention vs Resilience ---\n","\n","# User metrics\n","user_stats = df.groupby('user_id').agg(\n","    first_event=('start_time', 'min'),\n","    last_event=('start_time', 'max'),\n","    total_attendance=('event_id', 'count'),\n","    extreme_attendance=('is_extreme', 'sum')\n",").reset_index()\n","\n","user_stats['tenure_days'] = (user_stats['last_event'] - user_stats['first_event']).dt.days\n","user_stats['is_resilient'] = user_stats['extreme_attendance'] > 0\n","user_stats['resilience_ratio'] = user_stats['extreme_attendance'] / user_stats['total_attendance']\n","\n","# Compare Tenure\n","retention_comparison = user_stats.groupby('is_resilient')['tenure_days'].agg(['mean', 'median', 'count', 'std'])\n","\n","print(\"Retention Comparison (Resilient vs Non-Resilient):\")\n","print(retention_comparison)\n","\n","# --- Analysis 2: Casual vs Core Seasonal Churn ---\n","\n","# Define Casual vs Core based on total attendance quantile\n","threshold = user_stats['total_attendance'].quantile(0.75) # Top 25% are Core? Or maybe median?\n","# Let's use a fixed number for easier interpretation, or median.\n","# Let's see the distribution first.\n","print(\"\\nAttendance Distribution stats:\")\n","print(user_stats['total_attendance'].describe())\n","\n","median_attendance = user_stats['total_attendance'].median()\n","print(f\"\\nMedian Attendance: {median_attendance}\")\n","\n","# Let's define Casual as <= median, Core as > median\n","user_stats['user_type'] = np.where(user_stats['total_attendance'] > median_attendance, 'Core', 'Casual')\n","\n","# Merge user_type back to the main events df\n","df = df.merge(user_stats[['user_id', 'user_type']], on='user_id', how='left')\n","\n","# Group by User Type and Month to see seasonality\n","# We want to see the \"Average Attendance per User\" in that month, OR \"Proportion of active users\"\n","# A simple way: Count total check-ins per month for each group, normalize by the total check-ins for that group.\n","monthly_seasonality = df.groupby(['user_type', 'month']).size().reset_index(name='checkins')\n","\n","# Normalize\n","group_totals = df.groupby('user_type').size().reset_index(name='total_checkins')\n","monthly_seasonality = monthly_seasonality.merge(group_totals, on='user_type')\n","monthly_seasonality['percentage'] = monthly_seasonality['checkins'] / monthly_seasonality['total_checkins']\n","\n","print(\"\\nMonthly Seasonality (Percentage of annual check-ins):\")\n","print(monthly_seasonality.pivot(index='month', columns='user_type', values='percentage'))\n","\n","# --- Check specifically for Extreme Months drop ---\n","# Calculate the drop from (May/Jun) to (Jul/Aug) for both groups?\n","# Or just average percentage in extreme vs non-extreme months.\n","\n","seasonality_agg = df.groupby(['user_type', 'is_extreme']).size().reset_index(name='count')\n","seasonality_agg = seasonality_agg.merge(group_totals, on='user_type')\n","seasonality_agg['pct'] = seasonality_agg['count'] / seasonality_agg['total_checkins']\n","\n","print(\"\\nAttendance in Extreme vs Non-Extreme Months by User Type:\")\n","print(seasonality_agg)"],"outputs":[],"execution_count":null,"metadata":{"id":"xMROrEKXPIw4"}},{"cell_type":"markdown","source":["```text?code_stdout&code_event_index=6\n","Retention Comparison (Resilient vs Non-Resilient):\n","                    mean  median  count         std\n","is_resilient                                       \n","False          50.408605     0.0   6554  173.104349\n","True          396.944706   133.0   9332  537.628078\n","\n","Attendance Distribution stats:\n","count    15886.000000\n","mean        19.893302\n","std         69.299532\n","min          1.000000\n","25%          1.000000\n","50%          2.000000\n","75%          9.000000\n","max       1502.000000\n","Name: total_attendance, dtype: float64\n","\n","Median Attendance: 2.0\n","\n","Monthly Seasonality (Percentage of annual check-ins):\n","user_type    Casual      Core\n","month                        \n","1          0.039712  0.051145\n","2          0.035574  0.046859\n","3          0.059421  0.059086\n","4          0.112633  0.100854\n","5          0.071837  0.084867\n","6          0.090264  0.118178\n","7          0.101202  0.098200\n","8          0.118546  0.103950\n","9          0.123571  0.102558\n","10         0.107509  0.091569\n","11         0.083760  0.083396\n","12         0.055972  0.059338\n","\n","Attendance in Extreme vs Non-Extreme Months by User Type:\n","  user_type  is_extreme   count  total_checkins       pct\n","0    Casual           0    6586           10148  0.648995\n","1    Casual           1    3562           10148  0.351005\n","2      Core           0  195917          305877  0.640509\n","3      Core           1  109960          305877  0.359491\n","\n","```"],"metadata":{"id":"C22bHzsNPIw4"}},{"cell_type":"code","source":["# Check seasonality of cancellations\n","cancellation_reason_event['created_at'] = pd.to_datetime(cancellation_reason_event['created_at'])\n","cancellation_reason_event['month'] = cancellation_reason_event['created_at'].dt.month\n","\n","cancellation_counts = cancellation_reason_event.groupby('month').size().reset_index(name='counts')\n","print(\"Cancellation Counts by Month:\")\n","print(cancellation_counts)\n","\n","# Refined Retention Analysis\n","\n","# Metric: Median Tenure for users who attended in specific seasons\n","# Season definitions\n","winter_months = [12, 1, 2]\n","summer_months = [7, 8]\n","\n","# Flag for each user: Did they ever attend in Winter? Did they ever attend in Summer?\n","user_season_flags = df.groupby('user_id')['month'].agg(\n","    has_winter=lambda x: any(m in winter_months for m in x),\n","    has_summer=lambda x: any(m in summer_months for m in x)\n",").reset_index()\n","\n","# Merge with user stats (tenure)\n","user_analysis = user_stats[['user_id', 'tenure_days', 'total_attendance', 'user_type']].merge(user_season_flags, on='user_id')\n","\n","# Compare Tenure\n","print(\"\\nRetention (Median Tenure Days):\")\n","print(\"All Users:\", user_analysis['tenure_days'].median())\n","print(\"Winter Attendees:\", user_analysis[user_analysis['has_winter']]['tenure_days'].median())\n","print(\"Non-Winter Attendees:\", user_analysis[~user_analysis['has_winter']]['tenure_days'].median())\n","print(\"Summer Attendees:\", user_analysis[user_analysis['has_summer']]['tenure_days'].median())\n","print(\"Non-Summer Attendees:\", user_analysis[~user_analysis['has_summer']]['tenure_days'].median())\n","\n","# Check \"Casual\" churn in Winter vs Summer more explicitly\n","# We already saw the percentages. Casuals drop in Winter (13% vs 15.7%) and rise in Summer (21.9% vs 20.2%).\n","# Let's confirm the \"Casual\" definition (<= 2 events) is robust.\n","# What if we define Casual as \"attended only 1 month ever\"?\n","# But stick to the previous definition for consistency unless the result is weird.\n","\n","# Let's look at the Cancellation Reasons content to see if \"Adverse weather\" is mapped to specific IDs.\n","# ID 1: AQI > 150\n","# ID 2: Adverse Weather\n","print(\"\\nCancellation Reasons Mapping:\")\n","print(cancellation_reasons)\n","\n","# Check which months have the most AQI cancellations (ID 1)\n","aqi_cancellations = cancellation_reason_event[cancellation_reason_event['cancellation_reason_id'] == 1].groupby('month').size()\n","print(\"\\nAQI Cancellations by Month:\")\n","print(aqi_cancellations)\n","\n","# Check which months have the most Weather cancellations (ID 2)\n","weather_cancellations = cancellation_reason_event[cancellation_reason_event['cancellation_reason_id'] == 2].groupby('month').size()\n","print(\"\\nWeather Cancellations by Month:\")\n","print(weather_cancellations)"],"outputs":[],"execution_count":null,"metadata":{"id":"1coUA8ciPIw5"}},{"cell_type":"markdown","source":["```text?code_stdout&code_event_index=10\n","Cancellation Counts by Month:\n","    month  counts\n","0       1     965\n","1       2     599\n","2       3     622\n","3       4     516\n","4       5     477\n","5       6     522\n","6       7     494\n","7       8     420\n","8       9     640\n","9      10     729\n","10     11     744\n","11     12    1069\n","\n","Retention (Median Tenure Days):\n","All Users: 20.0\n","Winter Attendees: 342.0\n","Non-Winter Attendees: 0.0\n","Summer Attendees: 245.0\n","Non-Summer Attendees: 0.0\n","\n","Cancellation Reasons Mapping:\n","   id                                                name     slug created_at updated_at\n","0   1  {\"en\": \"AQI higher than 150\", \"zh\": \"空气质量指数超过150\"}      aqi        NaT        NaT\n","1   2             {\"en\": \"Adverse weather\", \"zh\": \"不良天气\"}  weather        NaT        NaT\n","2   3                         {\"en\": \"Other\", \"zh\": \"其他\"}    other        NaT        NaT\n","\n","AQI Cancellations by Month:\n","month\n","1     340\n","2     122\n","3     195\n","4     154\n","5     120\n","6      73\n","7      32\n","8      30\n","9      40\n","10    115\n","11    192\n","12    374\n","dtype: int64\n","\n","Weather Cancellations by Month:\n","month\n","1     137\n","2     148\n","3     121\n","4     100\n","5      97\n","6     181\n","7     205\n","8     133\n","9     197\n","10    155\n","11    150\n","12    142\n","dtype: int64\n","\n","```\n","\n","L'analyse des données valide en grande partie l'hypothèse **H4 (Environmental Resilience)**, avec une nuance importante concernant la température.\n","\n","Les conditions environnementales extrêmes agissent effectivement comme un filtre de loyauté, mais l'impact varie selon le type de condition : la **pollution (hiver)** est un filtre bien plus puissant que la **chaleur (été)**.\n","\n","Voici les conclusions détaillées basées sur les données :\n","\n","### 1\\. La Pollution (Hiver) : Le véritable \"Filtre de Loyauté\"\n","\n","L'hiver (décembre, janvier) concentre les conditions les plus difficiles, marquées par un pic de pollution.\n","\n","  * **Preuve de l'environnement extrême :** Les annulations liées à l'AQI (Qualité de l'Air) explosent en **Décembre (374)** et **Janvier (340)**, contre moins de 40 en été.\n","  * **Comportement des utilisateurs occasionnels (Churn saisonnier) :** Les utilisateurs occasionnels (*Casual Users*, $\\le$ 2 participations) décrochent massivement durant cette période. Leur présence chute à son niveau le plus bas de l'année (seulement \\~3.5% de leur activité annuelle en Février), une baisse de **\\~70%** par rapport à leur pic d'automne.\n","  * **Rétention long-terme :** Les utilisateurs qui bravent l'hiver (\"Pollution Resilient\") sont extrêmement fidèles. Leur durée de vie médiane est de **342 jours**, contre **0 jour** pour ceux qui évitent cette saison (souvent des utilisateurs uniques).\n","\n","### 2\\. La Chaleur (Été) : Une résilience inattendue des occasionnels\n","\n","Contrairement à l'hypothèse, la chaleur et les intempéries estivales ne font pas fuir les utilisateurs occasionnels.\n","\n","  * **Preuve de l'environnement extrême :** Les annulations pour \"Mauvais temps\" (Adverse Weather) culminent en **Juillet (205)** et Septembre (197).\n","  * **Comportement des utilisateurs occasionnels :** Au lieu de fuir, les utilisateurs occasionnels sont **sur-représentés** en été (Juillet/Août représentent \\~22% de leur activité totale vs \\~20% pour les membres \"Core\").\n","      * *Interprétation :* La motivation saisonnière (ex: \"Summer Body\") semble l'emporter sur l'inconfort climatique ou les risques d'intempéries.\n","  * **Rétention :** Bien que les participants estivaux soient fidèles (médiane de **245 jours**), ils le sont nettement moins que les \"guerriers de l'hiver\".\n","\n","### 3\\. Conclusion sur l'Hypothèse H4\n","\n","  * **\"Extreme environmental conditions serve as a loyalty filter\":** **VRAI**. Participer durant les extrêmes (Hiver ou Été) est fortement corrélé à une rétention élevée (\\>200 jours vs 0).\n","  * **\"Casual users exhibit strong seasonal churn\":** **VRAI, mais spécifique à l'Hiver**. Le churn est drastique durant les mois de pollution (Hiver), mais inexistant durant les mois de chaleur (Été).\n","\n","**Recommandation Data-Driven :**\n","L'hiver est votre moment de vérité. Les efforts de rétention (gamification, défis \"Winter Warrior\", récompenses de présence) devraient être massivement concentrés sur **Décembre-Février** pour contrer le churn naturel dû à la pollution. L'été, au contraire, est une période d'acquisition naturelle où les utilisateurs occasionnels affluent spontanément malgré la météo."],"metadata":{"id":"Cm1SV4MxPIw5"}}],"metadata":{"colab":{"provenance":[]},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}